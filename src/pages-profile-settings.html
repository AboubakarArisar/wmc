<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="light" data-bs-theme="light">
  <head>
    @@include('./partials/title-meta.html', {"title": "Profile Settings"})
    @@include('./partials/head-css.html')
    <style>
      .profile-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #f0f2f5 0%, #e0e4eb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .profile-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 600px;
        width: 100%;
        padding: 30px;
      }
      .profile-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .profile-header img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
      }
      .profile-header h4 {
        margin-bottom: 5px;
      }
      .profile-header p {
        color: #6c757d;
      }
      .form-group label {
        font-weight: 600;
      }
      .btn-primary {
        background-color: #667eea;
        border-color: #667eea;
      }
      .btn-primary:hover {
        background-color: #764ba2;
        border-color: #764ba2;
      }
      .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
      }
      .btn-danger:hover {
        background-color: #c82333;
        border-color: #c82333;
      }
      /* Loader overlay */
      .page-loader {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        backdrop-filter: blur(2px);
      }
      .page-loader.show {
        display: flex;
      }
      .loader-content {
        text-align: center;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div class="profile-page">
      <div class="profile-card">
        <div class="profile-header">
          <img
            src="assets/images/users/avatar-1.jpg"
            alt="Profile Picture"
            class="profile-picture"
          />
          <h4 class="user-name">Loading...</h4>
          <p class="user-email">Loading...</p>
        </div>

        <ul class="nav nav-tabs mb-3" id="profileTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="account-tab"
              data-bs-toggle="tab"
              data-bs-target="#account"
              type="button"
              role="tab"
              aria-controls="account"
              aria-selected="true"
            >
              Account
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="security-tab"
              data-bs-toggle="tab"
              data-bs-target="#security"
              type="button"
              role="tab"
              aria-controls="security"
              aria-selected="false"
            >
              Security
            </button>
          </li>
        </ul>
        <div class="tab-content" id="profileTabContent">
          <div
            class="tab-pane fade show active"
            id="account"
            role="tabpanel"
            aria-labelledby="account-tab"
          >
            <form id="profile-form">
              <div class="mb-3">
                <label for="profile-username" class="form-label"
                  >Username</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="profile-username"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="profile-email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="profile-email"
                  disabled
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Update Profile
              </button>
            </form>
          </div>
          <div
            class="tab-pane fade"
            id="security"
            role="tabpanel"
            aria-labelledby="security-tab"
          >
            <form id="password-form" class="mb-4">
              <div class="mb-3">
                <label for="current-password" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="current-password"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="new-password" class="form-label"
                  >New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="new-password"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="confirm-new-password" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirm-new-password"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Change Password
              </button>
            </form>

            <h5 class="mt-5">Delete Account</h5>
            <p class="text-muted">
              Permanently delete your account and all associated data.
            </p>
            <button id="delete-account-button" class="btn btn-danger">
              Delete Account
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader overlay -->
    <div id="page-loader" class="page-loader">
      <div class="loader-content">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2">Processing...</div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Use Firebase modular SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        updateProfile,
        updatePassword,
        EmailAuthProvider,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBY8bpwNwpCSyJX9yWosWULSXzQS9_qfm0",
        authDomain: "wmc-project-f5861.firebaseapp.com",
        projectId: "wmc-project-f5861",
        storageBucket: "wmc-project-f5861.firebasestorage.app",
        messagingSenderId: "92154463945",
        appId: "1:92154463945:web:d17fbfd846b0c1b1d1af18",
        measurementId: "G-CFBW3D9592",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const pageLoader = document.getElementById("page-loader");
      const showLoader = (message = "Processing...") => {
        if (pageLoader) {
          pageLoader.classList.add("show");
          const txt = pageLoader.querySelector(".loader-content div.mt-2");
          if (txt) txt.textContent = message;
        }
      };
      const hideLoader = () => {
        if (pageLoader) pageLoader.classList.remove("show");
      };

      class ProfileSettingsController {
        constructor() {
          this.user = null;
          this._authResolved = false;
          this.init();
        }

        init() {
          // Fallback: if auth doesn't resolve soon, go to login
          setTimeout(() => {
            if (!this._authResolved) {
              console.warn("Auth state not resolved, redirecting to login");
              window.location.href = "auth-login.html";
            }
          }, 4000);

          // Immediate fill if user is already available
          if (auth.currentUser) {
            this._authResolved = true;
            this.user = auth.currentUser;
            this.loadUserProfile(this.user);
          }

          onAuthStateChanged(auth, async (user) => {
            this._authResolved = true;
            if (user) {
              console.log("Auth user detected on profile page:", user.email);
              this.user = user;
              await this.loadUserProfile(user);
            } else {
              console.warn("No auth user on profile page, redirecting");
              window.location.href = "auth-login.html";
            }
          });

          document
            .getElementById("profile-form")
            .addEventListener("submit", this.updateProfile.bind(this));
          document
            .getElementById("password-form")
            .addEventListener("submit", this.changePassword.bind(this));
          document
            .getElementById("delete-account-button")
            .addEventListener("click", this.deleteAccount.bind(this));
        }

        async loadUserProfile(user) {
          try {
            const userDocRef = doc(db, "users", user.uid);
            const snap = await getDoc(userDocRef);
            const profileData = snap.exists() ? snap.data() : {};

            const displayName =
              user.displayName ||
              profileData.displayName ||
              profileData.username ||
              "No Name";
            document.querySelector(".user-name").textContent = displayName;
            document.querySelector(".user-email").textContent =
              user.email || "";
            document.getElementById("profile-username").value =
              displayName || "";
            document.getElementById("profile-email").value = user.email || "";
          } catch (error) {
            console.error("Error loading profile:", error);
            // Still render with basic auth info
            document.querySelector(".user-name").textContent =
              user.displayName || "No Name";
            document.querySelector(".user-email").textContent =
              user.email || "";
            document.getElementById("profile-username").value =
              user.displayName || "";
            document.getElementById("profile-email").value = user.email || "";
          }
        }

        async updateProfile(e) {
          e.preventDefault();
          const newUsername = document
            .getElementById("profile-username")
            .value.trim();
          if (!newUsername) {
            alert("Username cannot be empty");
            return;
          }
          if (this.user) {
            try {
              showLoader("Updating profile...");
              await updateProfile(this.user, { displayName: newUsername });
              const userDocRef = doc(db, "users", this.user.uid);
              await setDoc(
                userDocRef,
                {
                  displayName: newUsername,
                  username: newUsername,
                  updatedAt: new Date(),
                },
                { merge: true }
              );
              // Redirect to dashboard after a short delay
              setTimeout(() => {
                window.location.href = "index.html";
              }, 800);
            } catch (error) {
              let message = `Profile update failed: ${error.message}`;
              if (error.code === "auth/requires-recent-login") {
                message =
                  "For security, please log out and log in again, then retry updating your profile.";
              }
              alert(message);
              console.error("Profile update error:", error);
              hideLoader();
            }
          }
        }

        async changePassword(e) {
          e.preventDefault();
          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmNewPassword = document.getElementById(
            "confirm-new-password"
          ).value;

          if (newPassword !== confirmNewPassword) {
            alert("New passwords do not match!");
            return;
          }
          if (newPassword.length < 6) {
            alert("New password must be at least 6 characters");
            return;
          }

          if (this.user) {
            try {
              showLoader("Changing password...");
              await updatePassword(this.user, newPassword);
              alert("Password changed successfully!");
              document.getElementById("password-form").reset();
              hideLoader();
            } catch (error) {
              let message = `Password change failed: ${error.message}`;
              if (error.code === "auth/wrong-password") {
                message = "Current password is incorrect.";
              } else if (error.code === "auth/requires-recent-login") {
                message =
                  "Please log in again to continue. Redirecting to login...";
                alert(message);
                window.location.href = "auth-login.html";
                return;
              }
              alert(message);
              console.error("Password change error:", error);
              hideLoader();
            }
          }
        }

        async deleteAccount() {
          if (
            this.user &&
            confirm(
              "Are you sure you want to delete your account? This action cannot be undone."
            )
          ) {
            try {
              showLoader("Deleting account...");
              const uid = this.user.uid;
              await deleteDoc(doc(db, "users", uid));
              await deleteUser(this.user);
              alert("Account deleted successfully!");
              window.location.href = "auth-register.html";
            } catch (error) {
              let message = `Account deletion failed: ${error.message}`;
              if (error.code === "auth/requires-recent-login") {
                message =
                  "Please log in again to continue. Redirecting to login...";
                alert(message);
                window.location.href = "auth-login.html";
                return;
              }
              alert(message);
              console.error("Account deletion error:", error);
              hideLoader();
            }
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new ProfileSettingsController();
      });
    </script>
  </body>
</html>
