@@include('./partials/html.html')

<head>
    @@include("./partials/title-meta.html", {"title": "Dashboard"})
    @@include('./partials/head-css.html')
</head>

<body>
    <!-- Top Bar Start -->
    @@include('./partials/topbar.html')
    <!-- Top Bar End -->
    <!-- leftbar-tab-menu -->
    @@include('./partials/startbar.html')
    <!-- end leftbar-tab-menu-->

    <div class="page-wrapper">
        <!-- Page Content-->
        <div class="page-content">
            <div class="container-fluid">
                <div class="row align-items-stretch">
                    <div class="col-sm-12">
                        <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
                            <h4 class="page-title">Dashboard</h4>
                            <div class="">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="#">WMC</a></li>
                                    <li class="breadcrumb-item active">Dashboard</li>
                                </ol>
                            </div>                            
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0 bg-primary-subtle text-primary thumb-md rounded-circle">
                                        <i class="iconoir-dollar-circle fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2 text-truncate">
                                        <p class="text-dark mb-0 fw-semibold fs-14">Total Revenue</p>
                                        <p class="mb-0 text-truncate text-muted"><span class="text-success">8.5%</span>
                                            Increase from last month</p>
                                    </div>
                                </div>
                                <div class="row d-flex justify-content-center">
                                    <div class="col">                                        
                                        <h3 class="mt-2 mb-0 fw-bold revenue-card">Loading...</h3>
                                    </div>
                                    <div class="col align-self-center">
                                        <div id="revenueChart" style="height: 60px; width: 100px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0 bg-info-subtle text-info thumb-md rounded-circle">
                                        <i class="iconoir-cart fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2 text-truncate">
                                        <p class="text-dark mb-0 fw-semibold fs-14">New Orders</p>
                                        <p class="mb-0 text-truncate text-muted"><span class="text-success">1.7%</span>
                                            Increase from last month</p>
                                    </div>
                                </div>
                                <div class="row d-flex justify-content-center">
                                    <div class="col">                                        
                                        <h3 class="mt-2 mb-0 fw-bold orders-card">Loading...</h3>
                                    </div>
                                    <div class="col align-self-center">
                                        <div id="ordersChart" style="height: 60px; width: 100px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0 bg-warning-subtle text-warning thumb-md rounded-circle">
                                        <i class="iconoir-cancel fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2 text-truncate">
                                        <p class="text-dark mb-0 fw-semibold fs-14">Cancelled</p>
                                        <p class="mb-0 text-truncate text-muted"><span class="text-danger">0.7%</span>
                                            Decrease from last month</p>
                                    </div>
                                </div>
                                <div class="row d-flex justify-content-center">
                                    <div class="col">                                        
                                        <h3 class="mt-2 mb-0 fw-bold cancelled-card">Loading...</h3>
                                    </div>
                                    <div class="col align-self-center">
                                        <div id="cancelledChart" style="height: 60px; width: 100px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0 bg-danger-subtle text-danger thumb-md rounded-circle">
                                        <i class="iconoir-hexagon-dice fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-2 text-truncate">
                                        <p class="text-dark mb-0 fw-semibold fs-14">Avg. Order Value</p>
                                        <p class="mb-0 text-truncate text-muted"><span class="text-success">2.7%</span>
                                            Increase from last month</p>
                                    </div>
                                </div>
                                <div class="row d-flex justify-content-center">
                                    <div class="col">                                        
                                        <h3 class="mt-2 mb-0 fw-bold avg-order-card">Loading...</h3>
                                    </div>
                                    <div class="col align-self-center">
                                        <div id="avgOrderChart" style="height: 60px; width: 100px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Income Chart -->
                <div class="row align-items-stretch">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title">Monthly Income</h4>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="incomeRangeBtn">
                                        <i class="fas fa-calendar me-1"></i> <span id="incomeRangeLabel">This Month</span>
                                    </button>
                                    <ul class="dropdown-menu" id="incomeRangeMenu">
                                        <li><button type="button" class="dropdown-item" data-range="week">This Week</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="month">This Month</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="year">This Year</button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="monthlyIncomeChart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title">New Users</h4>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="newUsersRangeBtn">
                                        <i class="fas fa-calendar me-1"></i> <span id="newUsersRangeLabel">This Month</span>
                                    </button>
                                    <ul class="dropdown-menu" id="newUsersRangeMenu">
                                        <li><button type="button" class="dropdown-item" data-range="week">This Week</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="month">This Month</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="year">This Year</button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="newUsersChart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Registration by Country and Latest Cards -->
                <div class="row align-items-stretch">
                    <div class="col-lg-6 d-flex">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title">Top Registration by Country</h4>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="countryRangeBtn">
                                        <i class="fas fa-calendar me-1"></i> <span id="countryRangeLabel">This Month</span>
                                    </button>
                                    <ul class="dropdown-menu" id="countryRangeMenu">
                                        <li><button type="button" class="dropdown-item" data-range="week">This Week</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="month">This Month</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="year">This Year</button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Country</th>
                                                <th>Revenue</th>
                                                <th>Progress</th>
                                            </tr>
                                        </thead>
                                        <tbody id="countrySalesBody">
                                            <tr>
                                                <td colspan="3" class="text-center">
                                                    <div class="spinner-border" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 d-flex">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title">Latest Cards</h4>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="cardsRangeBtn">
                                        <i class="fas fa-calendar me-1"></i> <span id="cardsRangeLabel">This Year</span>
                                    </button>
                                    <ul class="dropdown-menu" id="cardsRangeMenu">
                                        <li><button type="button" class="dropdown-item" data-range="week">This Week</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="month">This Month</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="year">This Year</button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th>Registration Date</th>
                                                <th>Status</th>
                                                <th>Email</th>
                                            </tr>
                                        </thead>
                                        <tbody id="popularProductsBody">
                                            <tr>
                                                <td colspan="4" class="text-center">
                                                    <div class="spinner-border" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-3" id="cardsPagination" style="display:none;">
                                    <div class="text-muted small" id="cardsPageInfo">Page 1</div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" id="cardsPrev">Prev</button>
                                        <button class="btn btn-sm btn-outline-secondary" id="cardsNext">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New: Registered Users & Cards Trend -->
                <div class="row align-items-stretch mt-3">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title">New Registrations</h4>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="registrationsRangeBtn">
                                        <i class="fas fa-calendar me-1"></i> <span id="registrationsRangeLabel">This Month</span>
                                    </button>
                                    <ul class="dropdown-menu" id="registrationsRangeMenu">
                                        <li><button type="button" class="dropdown-item" data-range="week">This Week</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="month">This Month</button></li>
                                        <li><button type="button" class="dropdown-item" data-range="year">This Year</button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="registrationsTrendChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @@include('./partials/endbar.html')
    @@include('./partials/vendorjs.html')

    <script src="assets/libs/apexcharts/apexcharts.min.js"></script>
    <script src="https://apexcharts.com/samples/assets/stock-prices.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
  
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
       import { auth, db } from "./assets/js/services/firebase-service.js";



onAuthStateChanged(auth, (user) => {
  if (checked) return;  // prevent multiple redirects
  checked = true;

  if (!user) {
    console.log("No user, redirecting to login");
    window.location.replace("auth-login.html");
  } else {
    console.log("Dashboard loaded for:", user.email);
    // show dashboard UI
  }
});
    </script>
    
    <script src="assets/js/services/firebase-service.js"></script>
    <script src="assets/js/services/firebase-products.js"></script>
    <script src="assets/js/services/firebase-users-chart.js"></script>


    <!-- Dashboard Script -->
    <script>
        // Global variables
        let allCardsData = [];
        let cardsPage = 1;
        const cardsPageSize = 5;

        // Utility function
        function setText(selector, value) {
            const element = document.querySelector(selector);
            if (element) { 
                element.textContent = value; 
            }
        }

        // Date utilities for consistent filtering
        function getDateRange(range) {
            const now = new Date();
            let startDate, endDate;
            if (range === 'week') {
                const day = now.getDay();
                const diffToMonday = (day === 0 ? -6 : 1 - day);
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
            } else if (range === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
                endDate = new Date(now.getFullYear(), 11, 31);
            }
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            return { startDate, endDate };
        }

        function parseUserDate(dateSrc) {
            if (!dateSrc) return null;
            try {
                // Firestore Timestamp variants
                if (typeof dateSrc === 'object' && dateSrc.seconds) {
                    return new Date(dateSrc.seconds * 1000);
                }
                if (typeof dateSrc === 'object' && typeof dateSrc.toDate === 'function') {
                    return dateSrc.toDate();
                }
                // Strings and numbers
                let str = dateSrc;
                if (typeof dateSrc === 'number') {
                    // seconds or ms
                    if (dateSrc < 1e12) return new Date(dateSrc * 1000);
                    return new Date(dateSrc);
                }
                if (typeof dateSrc === 'string') {
                    str = dateSrc.trim();
                    // numeric string
                    if (/^\d{10,13}$/.test(str)) {
                        const n = parseInt(str, 10);
                        return n < 1e12 ? new Date(n * 1000) : new Date(n);
                    }
                    // dd/mm/yyyy or d/m/yyyy
                    const dm = str.match(/^([0-3]?\d)[\/\-]([0-1]?\d)[\/\-](\d{2,4})$/);
                    if (dm) {
                        const d = parseInt(dm[1], 10);
                        const m = parseInt(dm[2], 10) - 1;
                        const y = parseInt(dm[3].length === 2 ? (dm[3] > '50' ? '19'+dm[3] : '20'+dm[3]) : dm[3], 10);
                        return new Date(y, m, d);
                    }
                    // yyyy/mm/dd or yyyy-mm-dd
                    const ym = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})(.*)?$/);
                    if (ym) {
                        const y = parseInt(ym[1], 10);
                        const m = parseInt(ym[2], 10) - 1;
                        const d = parseInt(ym[3], 10);
                        return new Date(y, m, d);
                    }
                    // last resort: Date parse
                    const guess = new Date(str);
                    if (!isNaN(guess.getTime())) return guess;
                }
            } catch (e) { /* ignore */ }
            return null;
        }

        // Load REAL Stripe Data using Netlify Functions
        async function loadRealStripeData() {
            try {
                console.log('🔄 Loading REAL Stripe data from Netlify functions...');
                
                const response = await fetch('/.netlify/functions/stripe-metrics');
                const result = await response.json();
                
                if (result.success) {
                    const metrics = result.data;
                    console.log('✅ Real Stripe metrics loaded:', metrics);
                    
                    // Update dashboard cards with real data
                    setText('.revenue-card', metrics.totalRevenue.toLocaleString() + "kr");
                    setText('.orders-card', metrics.newOrders.toLocaleString());
                    setText('.cancelled-card', metrics.cancellations || 0);
                    setText('.avg-order-card', metrics.averageOrderValue.toLocaleString() + "kr");
                    
                    console.log('🎉 Dashboard updated with LIVE Stripe data!');
                } else {
                    console.error('❌ Stripe API error:', result.error);
                    setText('.revenue-card', 'API Error');
                    setText('.orders-card', 'API Error');
                    setText('.cancelled-card', 'API Error');
                    setText('.avg-order-card', 'API Error');
                }
                
            } catch (error) {
                console.error('❌ Error loading Stripe data:', error);
                setText('.revenue-card', 'Service Error');
                setText('.orders-card', 'Service Error');
                setText('.cancelled-card', 'Service Error');
                setText('.avg-order-card', 'Service Error');
            }
        }

        // Create mini charts for KPI cards
        function createMiniCharts() {
            // Revenue Chart - Line chart
            const revenueOptions = {
                chart: { type: 'line', height: 60, sparkline: { enabled: true } },
                stroke: { curve: 'smooth', width: 2 },
                colors: ['#4d7cff'],
                series: [{ data: [10, 20, 35, 45, 55, 70, 85, 95] }],
                tooltip: { enabled: false }
            };
            new ApexCharts(document.querySelector("#revenueChart"), revenueOptions).render();

            // Orders Chart - Bar chart
            const ordersOptions = {
                chart: { type: 'bar', height: 60, sparkline: { enabled: true } },
                colors: ['#4d7cff', '#ff6b6b'],
                series: [{ data: [20, 35, 25, 45, 30, 55, 40, 60] }],
                tooltip: { enabled: false }
            };
            new ApexCharts(document.querySelector("#ordersChart"), ordersOptions).render();

            // Cancelled Chart - Donut chart
            const cancelledOptions = {
                chart: { type: 'donut', height: 60, sparkline: { enabled: true } },
                colors: ['#4d7cff', '#ffc107', '#ff6b6b', '#28a745'],
                series: [30, 20, 25, 25],
                tooltip: { enabled: false },
                legend: { show: false }
            };
            new ApexCharts(document.querySelector("#cancelledChart"), cancelledOptions).render();

            // Avg Order Chart - Network chart
            const avgOrderOptions = {
                chart: { type: 'line', height: 60, sparkline: { enabled: true } },
                stroke: { curve: 'stepline', width: 2 },
                colors: ['#4d7cff'],
                series: [{ data: [15, 25, 20, 35, 30, 45, 40, 50] }],
                tooltip: { enabled: false }
            };
            new ApexCharts(document.querySelector("#avgOrderChart"), avgOrderOptions).render();
        }

        // Load Monthly Income Chart with REAL data from Stripe
        function loadMonthlyIncomeChart() {
            attachIncomeRangeHandlers();
            loadMonthlyIncome('month');
        }

        // Load Monthly Income data from Stripe
        async function loadMonthlyIncome(range = 'month') {
            try {
                const response = await fetch(`/.netlify/functions/stripe-monthly-income?range=${range}`);
                const result = await response.json();

                if (result.success) {
                    // Prefer rawData (contains total/count/avg); fallback to data.avg
                    const source = Array.isArray(result.rawData) && result.rawData.length
                      ? result.rawData
                      : (Array.isArray(result.data) ? result.data : []);

                    const data = source.map(item => ({
                        month: item.month,
                        income: Number(item.total != null ? item.total : item.avg) || 0
                    }));
                    updateMonthlyIncomeChart(data);
                } else {
                    console.error("❌ No monthly income data available");
                }
            } catch (error) {
                console.error("❌ Error loading monthly income:", error);
            }
        }

        // Update Monthly Income Chart
        function updateMonthlyIncomeChart(data) {
            const chartElement = document.querySelector("#monthlyIncomeChart");
            if (chartElement && window.ApexCharts) {
                const months = data.map(item => item.month);
                const incomes = data.map(item => item.income);

                const options = {
                    chart: {
                        type: "area",
                        height: 350,
                        toolbar: { show: false }
                    },
                    series: [
                        {
                            name: "Actual Income",
                            data: incomes.map(v => Number(v).toFixed(1))
                        }
                    ],
                    xaxis: {
                        categories: months,
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: {
                        labels: {
                            formatter: function (val) {
                                return Number(val).toFixed(1) + "kr";
                            }
                        }
                    },
                    colors: ["#3b82f6"],
                    fill: {
                        type: "solid",
                        opacity: 0.9
                    },
                    stroke: {
                        curve: "straight",
                        width: 2
                    },
                    grid: {
                        borderColor: "#f1f5f9",
                        strokeDashArray: 5
                    },
                    legend: {
                        show: false
                    },
                    dataLabels: {
                        enabled: false
                    },
                    tooltip: {
                        y: {
                            formatter: function(val) {
                                return Number(val).toFixed(1) + "kr";
                            }
                        }
                    }
                };

                // Destroy existing chart if it exists
                if (chartElement._apexChart) {
                    chartElement._apexChart.destroy();
                }

                // Create new chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
                chartElement._apexChart = chart;

                console.log("📊 Actual income chart updated with real data");
            } else {
                console.log("⚠️ Chart element or ApexCharts not found");
            }
        }

        // Wire range dropdown to reload chart
        function attachIncomeRangeHandlers() {
            const menu = document.getElementById('incomeRangeMenu');
            const label = document.getElementById('incomeRangeLabel');
            if (!menu || !label) return;
            menu.querySelectorAll('[data-range]').forEach(el => {
                el.addEventListener('click', () => {
                    const range = el.getAttribute('data-range');
                    label.textContent = el.textContent.trim();
                    loadMonthlyIncome(range);
                });
            });
        }

        // Load New Users Chart with REAL data from Firebase
        async function loadNewUsersChart(range = "month") {
            try {
                const allUsers = await window.FirebaseDataService.getCustomers();
                console.log("✅ Users loaded:", allUsers.length, "users");
                
                if (!allUsers || allUsers.length === 0) {
                    console.log("❌ No users available");
                    showNoDataMessage();
                    return;
                }
                
                const { startDate, endDate } = getDateRange(range);

                const periodUsers = allUsers.filter(user => {
                    // Prefer memberSince; fall back to createdAt
                    const dateSrc = user.memberSince || user.createdAt;
                    const userDate = parseUserDate(dateSrc);
                    if (!userDate) return false;
                    return userDate >= startDate && userDate <= endDate;
                });
                
                const otherUsers = allUsers.length - periodUsers.length;
                const totalUsers = allUsers.length;
                
                const newPct = totalUsers > 0 ? parseFloat(((periodUsers.length / totalUsers) * 100).toFixed(1)) : 0;
                const currentPct = totalUsers > 0 ? parseFloat((100 - newPct).toFixed(1)) : 0;
                const userData = {
                    current: currentPct,
                    new: newPct,
                    counts: {
                        current: otherUsers,
                        new: periodUsers.length,
                        total: totalUsers
                    }
                };

                
                console.log("✅ New users data calculated:", userData);
                console.log("📊 Range:", range, "Period users:", periodUsers.length, "Other users:", otherUsers);
                
                const options = {
                    chart: {
                        height: 300,
                        type: "donut",
                    },
                    series: [userData.current, userData.new],
                    labels: ["Other Periods", "Selected Period"],
                    colors: ["#8b5cf6", "#06b6d4"],
                    legend: {
                        position: "bottom",
                        horizontalAlign: "center",
                        formatter: function(seriesName, opts) {
                            try {
                                const key = seriesName.toLowerCase() === "other periods" ? "current" : "new";
                                const count = userData.counts[key] ?? 0;
                                const percentage = (opts && opts.w && opts.w.globals && opts.w.globals.series)
                                  ? opts.w.globals.series[opts.seriesIndex]
                                  : (key === 'current' ? userData.current : userData.new);
                                return seriesName + ": " + count + " users (" + percentage + "%)";
                            } catch (e) {
                                return seriesName;
                            }
                        }
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "70%",
                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: "Total Users",
                                        formatter: function() {
                                            return userData.counts.total;
                                        }
                                    }
                                }
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function (val) {
                            return (typeof val === 'number' ? val.toFixed(1) : val) + "%";
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function(val, opts) {
                                try {
                                    const label = (opts && opts.w && opts.w.globals && opts.w.globals.labels)
                                      ? opts.w.globals.labels[opts.seriesIndex].toLowerCase()
                                      : (opts.seriesIndex === 0 ? "other periods" : "selected period");
                                    const count = label === "other periods" ? userData.counts.current : userData.counts.new;
                                    const pct = typeof val === 'number' ? val.toFixed(1) : val;
                                    return count + " users (" + pct + "%)";
                                } catch (e) {
                                    return val + "%";
                                }
                            }
                        }
                    }
                };
                
                const chartElement = document.querySelector("#newUsersChart");
                if (chartElement) {
                    if (chartElement._apexChart) {
                        chartElement._apexChart.destroy();
                    }
                    
                    const chart = new ApexCharts(chartElement, options);
                    chart.render();
                    chartElement._apexChart = chart;
                    
                    console.log("📊 New users chart updated with real data");
                } else {
                    console.error("❌ Chart element not found");
                }
            } catch (error) {
                console.error("❌ Error loading new users chart:", error);
                showNoDataMessage();
            }
        }

        // Wire new users range dropdown
        function attachNewUsersRangeHandlers() {
            const menu = document.getElementById("newUsersRangeMenu");
            const label = document.getElementById("newUsersRangeLabel");
            if (!menu || !label) return;
            menu.querySelectorAll("[data-range]").forEach(el => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    const range = el.getAttribute("data-range");
                    label.textContent = el.textContent.trim();
                    loadNewUsersChart(range);
                });
            });
        }

        // Show no data message
        function showNoDataMessage() {
            const chartElement = document.querySelector("#newUsersChart");
            if (chartElement) {
                chartElement.innerHTML = "<div class='text-center p-4'><h6 class='text-muted'>No user data available</h6><p class='text-muted small'>Please check Firebase connection</p></div>";
            }
        }

        // Load Latest Cards from Firebase (Registered Users)
        async function loadLatestCards(range = "year") {
            try {
                const allUsers = await window.FirebaseDataService.getCustomers();
                console.log("✅ Users loaded:", allUsers.length, "users");
                
                if (!allUsers || allUsers.length === 0) {
                    console.log("❌ No users available");
                    displayLatestCards([]);
                    return;
                }
                
                let registeredUsers = allUsers.filter(user => user.cardOrderStatus === "Registered");
                console.log("📊 Found registered users:", registeredUsers.length);
                
                // Filter by date range if specified
                if (range !== "year") {
                    const now = new Date();
                    let startDate, endDate;

                    if (range === "week") {
                        const day = now.getDay();
                        const diffToMonday = (day === 0 ? -6 : 1 - day);
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 6);
                    } else if (range === "month") {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    }
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(23, 59, 59, 999);

                    registeredUsers = registeredUsers.filter(user => {
                        if (!user.cardOrderDate) return false;
                        const userDate = new Date(user.cardOrderDate);
                        return userDate >= startDate && userDate <= endDate;
                    });
                }
                
                // Sort by registration date desc if present
                registeredUsers.sort((a,b) => new Date(b.cardOrderDate || 0) - new Date(a.cardOrderDate || 0));
                
                const cards = registeredUsers.map(user => ({
                    id: user.id,
                    name: (user.firstName || "") + " " + (user.lastName || ""),
                    registrationDate: user.cardOrderDate,
                    status: user.cardOrderStatus || "Registered",
                    email: user.email || "N/A",
                }));
                console.log("✅ Cards generated:", cards.length);
                initCardsPagination(cards);
            } catch (error) {
                console.error("❌ Error loading cards:", error);
                displayLatestCards([]);
            }
        }

        // Pagination functions for Latest Cards
        function initCardsPagination(cards) {
            allCardsData = cards || [];
            cardsPage = 1;
            renderCardsPage();
            setupCardsPager();
        }

        function setupCardsPager() {
            const wrap = document.getElementById('cardsPagination');
            const prev = document.getElementById('cardsPrev');
            const next = document.getElementById('cardsNext');
            if (!wrap || !prev || !next) return;
            const totalPages = Math.max(1, Math.ceil(allCardsData.length / cardsPageSize));
            wrap.style.display = totalPages > 1 ? '' : 'none';
            prev.onclick = () => { if (cardsPage > 1) { cardsPage--; renderCardsPage(); } };
            next.onclick = () => { if (cardsPage < totalPages) { cardsPage++; renderCardsPage(); } };
        }

        function renderCardsPage() {
            const tbody = document.getElementById('popularProductsBody');
            const info = document.getElementById('cardsPageInfo');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!allCardsData || allCardsData.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center text-muted'>No registered users found</td></tr>";
                return;
            }
            const totalPages = Math.max(1, Math.ceil(allCardsData.length / cardsPageSize));
            if (cardsPage > totalPages) cardsPage = totalPages;
            const start = (cardsPage - 1) * cardsPageSize;
            const pageItems = allCardsData.slice(start, start + cardsPageSize);
            pageItems.forEach(card => {
                const row = `
                    <tr>
                        <td>${card.name || "N/A"}</td>
                        <td>${card.registrationDate || "N/A"}</td>
                        <td>${card.status || "N/A"}</td>
                        <td>${card.email || "N/A"}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            if (info) info.textContent = `Page ${cardsPage} of ${totalPages}`;
            const wrap = document.getElementById('cardsPagination');
            if (wrap) wrap.style.display = totalPages > 1 ? '' : 'none';
        }

        // Display latest cards data (kept for compatibility; now uses pagination)
        function displayLatestCards(cards) {
            initCardsPagination(cards);
        }

        // Load Country Sales from Stripe
        async function loadCountrySales(range = "month") {
            try {
                console.log("🔄 Loading country sales data from Stripe...");
                console.log("📊 Country filter range:", range);
                const response = await fetch(`/.netlify/functions/stripe-country-sales?range=${range}`);
                const result = await response.json();
                
                if (result.success) {
                    console.log("✅ Country sales data loaded:", result.data);
                    displayCountrySales(result.data);
                } else {
                    console.error("❌ Country sales error:", result.error);
                    displayCountrySales([]);
                }
            } catch (error) {
                console.error("❌ Error loading country sales:", error);
                displayCountrySales([]);
            }
        }

        // Display country sales data
        function displayCountrySales(countryData) {
            const countrySalesBody = document.getElementById("countrySalesBody");
            if (countrySalesBody) {
                countrySalesBody.innerHTML = "";
                
                if (countryData.length === 0) {
                    countrySalesBody.innerHTML = "<tr><td colspan='3' class='text-center text-muted'>No country data available</td></tr>";
                    return;
                }

                // Default countries with flags
                const defaultCountries = [
                    { name: "USA", flag: "us_flag.jpg" },
                    { name: "Spain", flag: "spain_flag.jpg" },
                    { name: "French", flag: "french_flag.jpg" },
                    { name: "Germany", flag: "germany_flag.jpg" },
                    { name: "Bahamas", flag: "baha_flag.jpg" },
                    { name: "Russia", flag: "russia_flag.jpg" }
                ];

                // Merge with real data and sort by revenue (desc)
                const countries = defaultCountries
                    .map(defaultCountry => {
                        const realData = countryData.find(c => c.name === defaultCountry.name);
                        return {
                            ...defaultCountry,
                            revenue: realData ? realData.revenue : 0,
                            percentage: realData ? realData.percentage : 0,
                            count: realData ? realData.count : 0
                        };
                    })
                    .sort((a, b) => b.revenue - a.revenue);

                countries.forEach(country => {
                    const row = `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="assets/images/flags/${country.flag}" alt="" class="me-2 thumb-sm rounded-circle">
                                    <span class="text-dark">${country.name}</span>
                                </div>
                            </td>
                            <td>${country.revenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}kr</td>
                            <td>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: ${country.percentage}%;" aria-valuenow="${country.percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                    countrySalesBody.insertAdjacentHTML("beforeend", row);
                });
            }
        }

        // Wire country range dropdown
        function attachCountryRangeHandlers() {
            const menu = document.getElementById("countryRangeMenu");
            const label = document.getElementById("countryRangeLabel");
            if (!menu || !label) return;
            menu.querySelectorAll("[data-range]").forEach(el => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    const range = el.getAttribute("data-range");
                    label.textContent = el.textContent.trim();
                    loadCountrySales(range);
                });
            });
        }

        // Wire cards range dropdown
        function attachCardsRangeHandlers() {
            const menu = document.getElementById("cardsRangeMenu");
            const label = document.getElementById("cardsRangeLabel");
            if (!menu || !label) return;
            menu.querySelectorAll("[data-range]").forEach(el => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    const range = el.getAttribute("data-range");
                    label.textContent = el.textContent.trim();
                    loadLatestCards(range);
                });
            });
        }

        // New Registrations Trend (users vs cards)
        async function loadRegistrationsTrend(range = "month") {
            try {
                const { startDate, endDate } = getDateRange(range);
                const allUsers = await window.FirebaseDataService.getCustomers();
                // Users new in range
                const newUsers = allUsers.filter(u => {
                    const d = parseUserDate(u.memberSince || u.createdAt);
                    return d && d >= startDate && d <= endDate;
                });
                // Cards registered in range (cardOrderStatus === "Registered")
                const newCards = allUsers.filter(u => {
                    if (u.cardOrderStatus !== "Registered") return false;
                    const d = parseUserDate(u.cardOrderDate || u.memberSince || u.createdAt);
                    return d && d >= startDate && d <= endDate;
                });

                // Build x-axis buckets like stripe-monthly-income
                let labels = [], usersSeries = [], cardsSeries = [];
                if (range === 'week') {
                    const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]; // start Monday
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(startDate); d.setDate(startDate.getDate() + i);
                        labels.push(dayNames[(d.getDay()+6)%7]);
                        const dayStart = new Date(d); dayStart.setHours(0,0,0,0);
                        const dayEnd = new Date(d); dayEnd.setHours(23,59,59,999);
                        usersSeries.push(newUsers.filter(u => { const du = parseUserDate(u.memberSince||u.createdAt); return du && du>=dayStart && du<=dayEnd; }).length);
                        cardsSeries.push(newCards.filter(u => { const dc = parseUserDate(u.cardOrderDate||u.memberSince||u.createdAt); return dc && dc>=dayStart && dc<=dayEnd; }).length);
                    }
                } else if (range === 'month') {
                    const year = startDate.getFullYear(); const month = startDate.getMonth();
                    const days = new Date(year, month+1, 0).getDate();
                    for (let i=1;i<=days;i++){ labels.push(String(i));
                        const dayStart = new Date(year, month, i, 0,0,0,0);
                        const dayEnd = new Date(year, month, i, 23,59,59,999);
                        usersSeries.push(newUsers.filter(u=>{ const du=parseUserDate(u.memberSince||u.createdAt); return du&&du>=dayStart&&du<=dayEnd;}).length);
                        cardsSeries.push(newCards.filter(u=>{ const dc=parseUserDate(u.cardOrderDate||u.memberSince||u.createdAt); return dc&&dc>=dayStart&&dc<=dayEnd;}).length);
                    }
                } else {
                    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                    for (let i=0;i<12;i++){ labels.push(monthNames[i]);
                        const mStart = new Date(startDate.getFullYear(), i, 1, 0,0,0,0);
                        const mEnd = new Date(startDate.getFullYear(), i+1, 0, 23,59,59,999);
                        usersSeries.push(newUsers.filter(u=>{ const du=parseUserDate(u.memberSince||u.createdAt); return du&&du>=mStart&&du<=mEnd;}).length);
                        cardsSeries.push(newCards.filter(u=>{ const dc=parseUserDate(u.cardOrderDate||u.memberSince||u.createdAt); return dc&&dc>=mStart&&dc<=mEnd;}).length);
                    }
                }

                const el = document.querySelector('#registrationsTrendChart');
                if (!el) return;
                if (el._apexChart) el._apexChart.destroy();
                const options = {
                    chart: { type: 'area', height: 350, toolbar: { show:false } },
                    series: [
                        { name: 'New Users', data: usersSeries },
                        { name: 'New Cards', data: cardsSeries }
                    ],
                    xaxis: { categories: labels },
                    yaxis: { labels: { formatter: (v)=> Math.round(v) } },
                    colors: ['#06b6d4', '#8b5cf6'],
                    dataLabels: { enabled:false },
                    stroke: { curve:'smooth', width:2 },
                    grid: { borderColor:'#f1f5f9', strokeDashArray:5 },
                    legend: { show:true, position:'top' }
                };
                const chart = new ApexCharts(el, options);
                chart.render();
                el._apexChart = chart;
            } catch (e) {
                console.error('❌ Error loading registrations trend:', e);
            }
        }

        function attachRegistrationsRangeHandlers() {
            const menu = document.getElementById('registrationsRangeMenu');
            const label = document.getElementById('registrationsRangeLabel');
            if (!menu || !label) return;
            menu.querySelectorAll('[data-range]').forEach(el => {
                el.addEventListener('click', () => {
                    const range = el.getAttribute('data-range');
                    label.textContent = el.textContent.trim();
                    loadRegistrationsTrend(range);
                });
            });
        }

        // Main initialization function
        document.addEventListener("DOMContentLoaded", async function() {
            // Wait for Firebase to be ready
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Load all data
            await loadRealStripeData();
            await loadCountrySales();
            await loadLatestCards();
            createMiniCharts();
            loadMonthlyIncomeChart();
            attachNewUsersRangeHandlers();
            attachCountryRangeHandlers();
            attachCardsRangeHandlers();
            attachRegistrationsRangeHandlers();
            await loadNewUsersChart("month");
            await loadRegistrationsTrend("month");
        });
    </script>
</body>
</html>
